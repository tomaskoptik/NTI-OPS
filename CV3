#include "main.h"
#include "mbed.h"
#include "stm32746g_discovery_lcd.h"
#include <stack>
#include <chrono>
DigitalOut myLed(LED1);
Mutex mutexLCD;
Mutex mutexParking;
std::stack<int> parkingSpots;
void initParkingSpots(int count) {
    for (int i = 0; i < count; ++i) {
        parkingSpots.push(i);
    }
}

Semafor::Semafor(int count) : slot(count) {}

void Semafor::acquire() {
    slot.acquire();
}

void Semafor::release() {
    slot.release();
}

int acquireParkingSpot() {
    mutexParking.lock();  // Použijte nový mutex
    if (parkingSpots.empty()) {
        mutexParking.unlock();
        return -1; 
    }
    int spot = parkingSpots.top();
    parkingSpots.pop();
    mutexParking.unlock();
    return spot;
}

void releaseParkingSpot(int spot) {
    mutexParking.lock();  // Použijte nový mutex
    parkingSpots.push(spot);
    mutexParking.unlock();
}

Car::Car(const char *name, int parkingTime, uint32_t bgColor, Semafor &semafor) 
    : car_name(name), parkTime(parkingTime), backgroundColor(bgColor), parkoviste(semafor) {}

void Car::operate() {
    while (true) {
        auto waitTime = milliseconds(rand() % 5000 + 3000);
        ThisThread::sleep_for(waitTime);

        parkoviste.acquire();

        int parkingSpot = acquireParkingSpot();
        if (parkingSpot != -1) {
            mutexLCD.lock();
            display(car_name, parkingSpot);
            mutexLCD.unlock();

            ThisThread::sleep_for(parkTime * 1s);

            mutexLCD.lock();
            clearParkingSpot(parkingSpot);
            mutexLCD.unlock();

            ThisThread::sleep_for(2s); 

            releaseParkingSpot(parkingSpot);
        }

        parkoviste.release();
    }
}

void Car::display(const char *name, int parkingSpot) {
    int lineOffset = LINE(5) + 30 * parkingSpot;
    BSP_LCD_SetFont(&LCD_DEFAULT_FONT);
    BSP_LCD_SetBackColor(backgroundColor);
    BSP_LCD_SetTextColor(LCD_COLOR_BLACK);
    BSP_LCD_DisplayStringAt(0, lineOffset, (uint8_t *)name, CENTER_MODE);
}

int main() {
    srand((unsigned) time(NULL));

    BSP_LCD_Init();
    BSP_LCD_LayerDefaultInit(LTDC_ACTIVE_LAYER, LCD_FB_START_ADDRESS);
    BSP_LCD_SelectLayer(LTDC_ACTIVE_LAYER);
    BSP_LCD_Clear(LCD_COLOR_BLACK);

    initParkingSpots(4);

    Semafor parkoviste(4);
    Car cars[] = {
        Car("CAR 1", 3, LCD_COLOR_RED, parkoviste),
        Car("CAR 2", 4, LCD_COLOR_GREEN, parkoviste),
        Car("CAR 3", 2, LCD_COLOR_BLUE, parkoviste),
        Car("CAR 4", 5, LCD_COLOR_YELLOW, parkoviste),
        Car("CAR 5", 3, LCD_COLOR_MAGENTA, parkoviste),
        Car("CAR 6", 6, LCD_COLOR_CYAN, parkoviste)
    };

    Thread threads[6];

    for (int i = 0; i < 6; i++) {
        threads[i].start([&cars, i]() { cars[i].operate(); });
    }

    while (true) {
    }
}
